# Recruit餐厅访客预测项目综合文档

## 1. 项目概述

### 1.1 项目背景

本项目基于日本餐厅数据，利用迁移学习技术预测餐厅客流量。数据来源于Recruit Holdings公司旗下的两个平台：

- **Hot Pepper Gourmet (HPG)**: 类似于Yelp的餐厅点评服务，用户可以搜索餐厅并在线预订
- **AirREGI / Restaurant Board (AIR)**: 类似于Square的餐厅预订控制系统和收银系统

该项目旨在使用预订、访问和其他信息来预测未来特定日期的餐厅访客总数，这有助于餐厅更有效地采购食材和安排员工，提高运营效率。

### 1.2 核心预测问题

基于餐厅的历史访客记录、预订数据、日期特征（节假日/周末）、店铺属性（类型/区域）等信息，预测AIR系列餐厅未来的日访客数量，属于时间序列回归任务。

### 1.3 评估指标

提交结果使用均方根对数误差(RMSLE)进行评估：

$$\text{RMSLE} = \sqrt{\frac{1}{n}\sum_{i=1}^{n}(\log(p_i + 1) - \log(a_i + 1))^2}$$

其中：
- n 是总观察数
- p_i 是对访客的预测
- a_i 是实际访客数
- log(x) 是 x 的自然对数

## 2. 数据集描述

### 2.1 数据集构成

这是一个来自两个系统的关联数据集。每个文件都以来源前缀（air_ 或 hpg_）标明其来源。每个餐厅都有唯一的air_store_id和hpg_store_id。需要注意的是，并非所有餐厅都被两个系统覆盖，而且提供给你的数据超出了你必须预测的餐厅范围。为了防止餐厅去标识化，纬度和经度并不完全精确。

### 2.2 文件详细说明

#### air_reserve.csv
此文件包含在AIR系统中进行的预订。

- air_store_id - AIR系统中的餐厅ID
- visit_datetime - 预订时间
- reserve_datetime - 创建预订的时间
- reserve_visitors - 该预订的访客数量

#### hpg_reserve.csv
此文件包含在HPG系统中进行的预订。

- hpg_store_id - HPG系统中的餐厅ID
- visit_datetime - 预订时间
- reserve_datetime - 创建预订的时间
- reserve_visitors - 该预订的访客数量

#### air_store_info.csv
此文件包含选定AIR餐厅的信息。

- air_store_id
- air_genre_name
- air_area_name
- latitude
- longitude
> 注意：纬度和经度是该餐厅所属区域的纬度和经度

#### hpg_store_info.csv
此文件包含选定HPG餐厅的信息。

- hpg_store_id
- hpg_genre_name
- hpg_area_name
- latitude
- longitude
> 注意：纬度和经度是该餐厅所属区域的纬度和经度

#### store_id_relation.csv
此文件允许你连接同时拥有AIR和HPG系统的选定餐厅。

- hpg_store_id
- air_store_id

#### air_visit_data.csv
此文件包含AIR餐厅的历史访问数据。

- air_store_id
- visit_date - 日期
- visitors - 该日期餐厅的访客数量

#### sample_submission.csv
此文件显示了正确格式的提交，包括必须预测的日期。

- id - ID由air_store_id和visit_date用下划线连接而成
- visitors - 预测的商店和日期组合的访客数量

#### date_info.csv
此文件提供了数据集中日历日期的基本信息。

- calendar_date
- day_of_week
- holiday_flg - 该日在日本是否为假日

## 3. 项目架构与实施步骤

### 3.1 项目结构

```
.
├── data/                    # 原始数据目录
├── src/                     # 源代码目录
│   └── data_processing/     # 数据处理模块
│       ├── data_loader.py   # 数据加载模块
│       ├── feature_engineering.py  # 特征工程模块
│       └── feat_eng_v2.py   # V2版特征工程模块
├── outputs/                 # 输出数据目录
├── main.py                  # 主程序入口
├── requirements.txt         # 项目依赖
└── 项目综合文档.md          # 项目综合文档
```

### 3.2 数据处理流程

#### 第一步：数据合并(Merge Data Pipeline)

1. 合并AIR和HPG预订数据，形成统一的预订数据表，包含store_id × reserve_date × visit_date的组合
2. 只保留那些在AIR访问数据表中存在的store_id
3. 生成两个中间产物：
   - 预测表：包含需要预测的所有样本（AIR测试集）
   - 访客表：包含历史访问数据（AIR训练集和HPG训练集）

#### 第二步：特征工程(Feature Engineering Pipeline)

1. **基础特征构建**：
   - 日期特征：星期几、是否周末/节假日等
   - 地理位置特征：经纬度信息
   - 餐厅属性特征：类型、区域等的计数编码

2. **预订相关特征**：
   - 统计每个餐厅的预订情况（预订提前天数、预订人数等）
   - 按日期聚合的预订特征

3. **历史访问特征**：
   - 不同时间窗口内的统计特征（均值、中位数、最大值、最小值、标准差等）

#### 第三步：数据集划分

根据时间顺序将AIR平台数据划分为训练集和测试集：
- 训练集：2016-01-01至2017-04-14
- 测试集：2017-04-15至2017-04-22

注意：保持时间顺序，避免未来信息泄露。

#### 第四步：构建HPG训练和测试数据

对于HPG数据，我们通过以下方式构建训练和测试数据集：
1. 利用HPG预订数据，通过store_id_relation.csv映射到AIR平台的ID体系
2. 根据AIR访问数据的时间划分原则，对HPG数据进行相同的训练/测试划分
3. 使用HPG预订数据作为特征输入，AIR访问数据作为标签输出

#### 第五步：生成标准化中间产物

生成四个标准化的数据集文件：
1. **air_train.csv**: AIR平台训练集，包含特征X和真实标签Y，以及is_air_only和is_train标记
2. **air_test.csv**: AIR平台测试集，包含特征X和真实标签Y，以及is_air_only和is_train标记
3. **hpg_train.csv**: HPG平台训练集，包含特征X和真实标签Y（来自AIR访问数据），以及is_air_only和is_train标记
4. **hpg_test.csv**: HPG平台测试集，包含特征X和真实标签Y（来自AIR访问数据），以及is_air_only和is_train标记

这些数据集将作为后续迁移学习任务的输入。

## 4. 迁移学习策略

### 4.1 领域划分

| 领域类型 | 数据来源 | 核心特征 | 目标 |
|---------|---------|---------|------|
| 源领域(Source Domain) | HPG餐厅数据（关联AIR餐厅的子集） | 访客规律、预订特征、日期特征 | 学习通用的餐厅访客预测知识 |
| 目标领域(Target Domain) | AIR餐厅数据 | 同源领域核心特征（分布略有差异） | 精准预测AIR餐厅访客数 |

### 4.2 迁移学习核心动机

- HPG餐厅和AIR餐厅虽分属不同体系，但共享通用访客规律（如周末访客高峰、节假日客流上升、预订数与实际访客正相关）；
- 利用源领域丰富的标注数据学习通用模式，迁移到目标领域，解决目标领域数据稀疏问题。

### 4.3 迁移方案设计

#### 方案1：预训练-微调（传统迁移学习）

属于参数迁移范畴，核心逻辑：

1. **预训练**：在源领域（HPG）数据上训练模型，学习通用特征（如"节假日→访客数上升"）；
2. **微调**：将预训练模型的参数作为初始值，用目标领域（AIR）少量数据微调参数，适配目标领域特有规律；
3. 优势：实现简单，无需修改特征，直接复用预训练的通用知识。

#### 方案2：CORAL+微调（领域自适应增强）

CORAL（Correlation Alignment）是特征迁移类的轻量级领域自适应算法，核心逻辑：

1. **协方差对齐**：计算源/目标领域特征的协方差矩阵，通过转换矩阵将目标领域特征映射到源领域分布空间，减少领域偏移；
2. **微调**：用对齐后的目标特征微调预训练模型，进一步提升泛化能力；
3. 数学原理：
   - 源领域协方差矩阵 C_S = cov(X_S)，目标领域协方差矩阵 C_T = cov(X_T)；
   - 转换矩阵 M = C_S^(1/2) · C_T^(-1/2)；
   - 转换后目标特征 X_T' = X_T · M。

## 5. 技术实现细节

### 5.1 环境依赖

项目主要依赖以下Python库：
- polars: 高性能数据处理库
- numpy: 数值计算库
- scikit-learn: 机器学习库

### 5.2 核心代码组件

#### 数据加载模块 (data_loader.py)
负责加载和预处理所有原始数据文件，包括：
- 对访客数量进行对数变换
- 处理预订数据的时间信息
- 合并关联数据

#### 特征工程模块 (feature_engineering.py)
负责构建各种特征，包括：
- 基础特征（日期、地理位置等）
- 预订相关特征
- 历史访问特征

#### V2版特征工程模块 (feat_eng_v2.py)
提供更API化的特征工程接口，接收合并后的预订数据和访客数据，输出包含特征X和目标Y的标准化表。该模块具有以下特点：
- 更清晰的输入输出接口
- 更好的模块化设计
- 与原始solution.py完全对齐的特征计算逻辑

#### 主程序 (main.py)
协调整个数据处理流程，包括：
- 调用数据加载模块
- 执行特征工程
- 划分数据集
- 生成标准化输出文件

### 5.3 运行方法

在项目根目录下执行：
```bash
python main.py
```

程序将自动完成以下步骤：
1. 加载并预处理数据
2. 进行特征工程
3. 按时间划分训练集和测试集
4. 生成标准化的中间产物文件

输出文件位于outputs/目录下：
- air_train.csv: AIR平台训练集
- air_test.csv: AIR平台测试集
- hpg_train.csv: HPG平台训练集
- hpg_test.csv: HPG平台测试集

## 6. 预期效果与注意事项

### 6.1 预期效果

| 模型 | 预期RMSE范围 | 核心优势 |
|------|-------------|----------|
| 纯目标领域模型 | ~0.50-0.55 | 无领域偏移，但数据稀疏时泛化差 |
| 预训练-微调模型 | ~0.47-0.50 | 复用源领域通用知识，比基线低0.02-0.05 |
| CORAL+微调模型 | ~0.45-0.48 | 进一步对齐特征分布，比预训练-微调低0.01-0.03 |

### 6.2 关键注意事项

1. **特征一致性**：CORAL要求源/目标领域特征维度完全一致，需通过feature_cols严格筛选；
2. **标准化**：CORAL对特征尺度敏感，必须先标准化；
3. **微调轮次**：微调轮次需少于预训练，避免遗忘源领域知识；
4. **数据关联**：源领域建议仅使用store_id_relation.csv关联的HPG店铺，减少无效噪声；
5. **异常值处理**：访客数存在极端值，需通过对数转换（np.log1p）缓解分布偏态。

## 7. 总结

本项目将迁移学习（预训练-微调）与领域自适应（CORAL）结合，解决了Recruit餐厅访客预测中目标领域数据稀疏、跨领域分布差异的问题。相比传统单领域模型，迁移学习方案能显著提升预测精度，且CORAL的引入进一步增强了模型对领域偏移的鲁棒性，是时间序列回归任务中迁移学习的典型实践。