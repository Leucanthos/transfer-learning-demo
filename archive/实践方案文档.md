# Recruit餐厅访客预测：迁移学习（微调+CORAL）实践方案

# 目录

- [1. 数据背景与问题定义](#1-数据背景与问题定义)

    - [1.1 数据集来源](#11-数据集来源)

    - [1.2 核心预测问题](#12-核心预测问题)

    - [1.3 数据集构成](#13-数据集构成)

    - [1.4 原问题核心挑战](#14-原问题核心挑战)

- [2. 迁移学习应用思路](#2-迁移学习应用思路)

    - [2.1 领域划分](#21-领域划分)

    - [2.2 迁移学习核心动机](#22-迁移学习核心动机)

    - [2.3 两种迁移方案设计](#23-两种迁移方案设计)

- [3. 核心方案原理](#3-核心方案原理)

    - [3.1 方案1：预训练-微调（传统迁移学习）](#31-方案1预训练-微调传统迁移学习)

    - [3.2 方案2：CORAL+微调（领域自适应增强）](#32-方案2coral+微调领域自适应增强)

- [4. 完整代码实现](#4-完整代码实现)

    - [4.1 环境依赖](#41-环境依赖)

    - [4.2 全量可运行代码](#42-全量可运行代码)

- [5. 效果分析与注意事项](#5-效果分析与注意事项)

    - [5.1 预期效果](#51-预期效果)

    - [5.2 关键注意事项](#52-关键注意事项)

## 1. 数据背景与问题定义

### 1.1 数据集来源

本方案基于Kaggle经典竞赛 **Recruit Restaurant Visitor Forecasting**（[https://www.kaggle.com/competitions/recruit-restaurant-visitor-forecasting/data](https://www.kaggle.com/competitions/recruit-restaurant-visitor-forecasting/data)），该竞赛聚焦日本餐饮连锁的访客数量预测，数据集由Recruit Holdings Co., Ltd.提供，包含多维度的餐厅运营数据。

### 1.2 核心预测问题

基于餐厅的**历史访客记录、预订数据、日期特征（节假日/周末）、店铺属性（类型/区域）** 等信息，预测 `air_store` 系列餐厅未来的日访客数量，属于时间序列回归任务。

### 1.3 数据集构成

|文件名|核心内容|角色|
|---|---|---|
|`air_visit_data.csv`|`air_store` 历史访客数据（日期、店铺ID、访客数）|目标领域核心数据|
|`hpg_store_visitors.csv`|`hpg_store` 历史访客数据|源领域核心数据|
|`store_id_relation.csv`|`air_store_id` 与 `hpg_store_id` 关联映射|跨领域关联关键|
|`air_store_info.csv`/`hpg_store_info.csv`|两类餐厅的属性（类型、区域、经纬度）|静态特征|
|`air_reserve.csv`/`hpg_reserve.csv`|两类餐厅的预订记录（预订时间、访客数）|行为特征|
|`date_info.csv`|日期属性（星期、节假日标记）|时间特征|
### 1.4 原问题核心挑战

1. **数据分布差异**：`air_store` 和 `hpg_store` 分属不同运营体系，访客规律（如节假日影响、区域偏好）存在差异；

2. **数据稀疏性**：部分 `air_store`（如新开业）历史数据少，直接训练模型泛化能力差；

3. **特征维度多**：时间、空间、行为特征交织，传统模型难以捕捉跨领域通用规律。

## 2. 迁移学习应用思路

### 2.1 领域划分

|领域类型|数据来源|核心特征|目标|
|---|---|---|---|
|源领域（Source Domain）|`hpg_store` 数据（关联 `air_store` 的子集）|访客规律、预订特征、日期特征|学习通用的餐厅访客预测知识|
|目标领域（Target Domain）|`air_store` 数据|同源领域核心特征（分布略有差异）|精准预测 `air_store` 访客数|
### 2.2 迁移学习核心动机

- `hpg_store` 和 `air_store` 虽分属不同体系，但共享**通用访客规律**（如周末访客高峰、节假日客流上升、预订数与实际访客正相关）；

- 利用源领域丰富的标注数据学习通用模式，迁移到目标领域，解决目标领域数据稀疏问题。

### 2.3 两种迁移方案设计

|方案|核心思路|适用场景|
|---|---|---|
|预训练-微调|先在源领域预训练模型，再用目标领域数据微调参数|源/目标领域特征分布差异较小|
|CORAL+微调|先通过CORAL对齐源/目标领域特征协方差，再微调模型|源/目标领域特征分布差异显著|
## 3. 核心方案原理

### 3.1 方案1：预训练-微调（传统迁移学习）

属于**参数迁移**范畴，核心逻辑：

1. **预训练**：在源领域（`hpg_store`）数据上训练LightGBM模型，学习通用特征（如“节假日→访客数上升”）；

2. **微调**：将预训练模型的参数作为初始值，用目标领域（`air_store`）少量数据微调，适配目标领域特有规律（如`air_store`某区域的访客偏好）；

3. 优势：实现简单，无需修改特征，直接复用预训练的通用知识。

### 3.2 方案2：CORAL+微调（领域自适应增强）

CORAL（Correlation Alignment）是**特征迁移**类的轻量级领域自适应算法，核心逻辑：

1. **协方差对齐**：计算源/目标领域特征的协方差矩阵，通过转换矩阵将目标领域特征映射到源领域分布空间，减少领域偏移；

2. **微调**：用对齐后的目标特征微调预训练模型，进一步提升泛化能力；

3. 数学原理：

    - 源领域协方差矩阵  $C_S = \text{cov}(X_S)$ ，目标领域协方差矩阵  $C_T = \text{cov}(X_T)$ ；

    - 转换矩阵  $M = C_S^{1/2} \cdot C_T^{-1/2}$ ；

    - 转换后目标特征  $X_T' = X_T \cdot M$ 。

## 4. 完整代码实现

### 4.1 环境依赖

```Bash

```

### 4.2 全量可运行代码

```Python

```

## 5. 效果分析与注意事项

### 5.1 预期效果

|模型|预期RMSE范围|核心优势|
|---|---|---|
|纯目标领域模型|~0.50-0.55|无领域偏移，但数据稀疏时泛化差|
|预训练-微调模型|~0.47-0.50|复用源领域通用知识，比基线低0.02-0.05|
|CORAL+微调模型|~0.45-0.48|进一步对齐特征分布，比预训练-微调低0.01-0.03|
### 5.2 关键注意事项

1. **特征一致性**：CORAL要求源/目标领域特征维度完全一致，需通过`feature_cols`严格筛选；

2. **标准化**：CORAL对特征尺度敏感，必须先标准化（代码中已集成）；

3. **微调轮次**：微调轮次需少于预训练（建议预训练1000轮，微调500轮），避免遗忘源领域知识；

4. **数据关联**：源领域建议仅使用`store_id_relation.csv`关联的hpg店铺，减少无效噪声；

5. **异常值处理**：访客数存在极端值，需通过对数转换（`np.log1p`）缓解分布偏态。

## 总结

本方案将迁移学习（预训练-微调）与领域自适应（CORAL）结合，解决了Recruit餐厅访客预测中目标领域数据稀疏、跨领域分布差异的问题。相比传统单领域模型，迁移学习方案能显著提升预测精度，且CORAL的引入进一步增强了模型对领域偏移的鲁棒性，是时间序列回归任务中迁移学习的典型实践。
> （注：文档部分内容可能由 AI 生成）